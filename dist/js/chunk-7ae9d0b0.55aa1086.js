(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-7ae9d0b0"],{"0ba4":function(t,e,n){t.exports=n.p+"img/img_weapon.76447149.png"},"12cc":function(t,e,n){"use strict";n.r(e);var i=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"compose-container"},[i("div",{staticClass:"compose-wrap d-flex"},[i("div",{staticClass:"hero-wrap d-flex flex-column align-center justify-center"},[t._m(0),t._m(1),i("div",{staticClass:"hero-avatar"},[i("div",{staticClass:"avatar-head"},[t.selectedUnits[1]?i("img",{attrs:{src:n("8336"),alt:""}}):t._e()]),i("div",{staticClass:"avatar-body"},[t.selectedUnits[2]?i("img",{attrs:{src:n("5a88"),alt:""}}):t._e(),i("div",{staticClass:"avatar-hand left"},[t.selectedUnits[3]?i("img",{attrs:{src:n("2b18"),alt:""}}):t._e()]),i("div",{staticClass:"avatar-hand right"},[t.selectedUnits[3]?i("img",{attrs:{src:n("2b18"),alt:""}}):t._e()])]),i("div",{staticClass:"avatar-leg"},[t.selectedUnits[4]?i("img",{attrs:{src:n("ea65"),alt:""}}):t._e()]),i("div",{staticClass:"avatar-weapon"},[t.selectedUnits[5]?i("img",{attrs:{src:n("0ba4"),alt:""}}):t._e()])]),i("div",{staticClass:"merge-amount"},[t._v("消耗 "+t._s(t.mergeAmount)+" ICE")]),i("p-button",{attrs:{loading:t.loading,text:t.GTAllowance>0?"确认组合":"授权"},on:{confirm:t.composeUnit}})],1),i("div",{staticClass:"part-wrap"},[i("div",{staticClass:"part-content"},[i("div",{staticClass:"profession-filter d-flex justify-space-between"},t._l(t.professionOptions,(function(e,n){return i("div",{key:n,staticClass:"filter-item",class:t.currentProfession==e.value?"active":"",on:{click:function(n){return t.filterUnit(e.value)}}},[t._v(t._s(e.name))])})),0),i("div",{staticClass:"part-items scroll-wrap"},[t._l(t.currentUnits,(function(e,n){return i("div",{key:n,staticClass:"part-item",class:"quality"+e.quality,on:{click:function(n){return t.selectUnit(e)}}},[i("p-card",{attrs:{item:e,selectedUnits:t.selectedUnits}})],1)})),t.currentUnits.length?t._e():i("div",{staticClass:"part-empty"},[t._v("暂无部件")])],2)]),i("div",{staticClass:"part-filter d-flex flex-column align-center justify-center"},t._l(t.partOptions,(function(e,n){return i("div",{key:n,staticClass:"filter-item",class:(t.currentPart==e.value?"active":"")+" filter-item"+(n+1),on:{click:function(n){return t.filterUnit(null,e.value)}}},[t._v(t._s(e.name))])})),0)])]),i("p-confirm",{ref:"pConfirm"})],1)},s=[function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"hero-base"},[i("img",{attrs:{src:n("3ab5"),alt:""}})])},function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"hero-light"},[i("img",{attrs:{src:n("9cfc"),alt:""}})])}],a=n("1da1"),r=n("5530"),c=(n("96cf"),n("e9c4"),n("4e827"),n("d3b7"),n("159b"),n("0481"),n("4069"),n("07ac"),n("b64b"),n("d81d"),n("4d63"),n("c607"),n("ac1f"),n("2c3e"),n("25f0"),n("5319"),n("2e4a")),o=n("d230"),l=n("82c1"),u=n("3da1"),f=n("89cb"),h=n("ed08"),m=n("dd70"),d=n("2f62"),g=n("3ee0"),p=g.Ice,v=p.address,b=p.abi,_=g.Unit,w=_.address,U=_.abi,C=g.Merge,y=C.address,T=C.abi,x={name:"GameAssemble",components:{PConfirm:c["a"],PCard:o["a"],PButton:l["a"]},mixins:[u["a"]],data:function(){return{goldCTR:null,unitCTR:null,mergeCTR:null,loading:!1,retry:0,maxRetry:3,selectedUnits:{},hero:null,GTAllowance:0,mergeAmount:0}},mounted:function(){this.pConfirm=this.$refs.pConfirm},methods:Object(r["a"])(Object(r["a"])({},Object(d["b"])(["setGT"])),{},{init:function(){var t=this;return Object(a["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.goldCTR=new t.web3.eth.Contract(b,v),t.unitCTR=new t.web3.eth.Contract(U,w),t.mergeCTR=new t.web3.eth.Contract(T,y),t.getMergeAmount(),t.getGTAllowance(),t.getGTBalance(),!Object(h["d"])("UNIT_CODE_RULE")){e.next=10;break}t.rules=Object(h["d"])("UNIT_CODE_RULE"),e.next=14;break;case 10:return e.next=12,t.getRules();case 12:t.rules=e.sent,Object(h["g"])("UNIT_CODE_RULE",JSON.stringify(t.rules));case 14:t.getUnit();case 15:case"end":return e.stop()}}),e)})))()},initUnit:function(){this.originUnits.sort((function(t,e){return e.timestamp-t.timestamp})),this.units=this.groupUnit(this.originUnits),console.warn("group units",this.units),this.filterUnit(1,0)},groupUnit:function(t){var e={};return t.forEach((function(t){var n=t.profession,i=t.part;e[n]||(e[n]={}),e[n][i]||(e[n][i]=[]),e[n][i].push(t)})),e},filterUnit:function(t,e){this.loading||(null!==t&&(this.currentProfession=t,this.selectedUnits={}),void 0!==e&&(this.currentPart=e),this.units[this.currentProfession]?0==this.currentPart?this.currentUnits=Object.values(this.units[this.currentProfession]).flat(1)||[]:this.currentUnits=this.units[this.currentProfession][this.currentPart]||[]:this.currentUnits=[])},selectUnit:function(t){if(!this.loading){var e=this.selectedUnits[t.part]&&this.selectedUnits[t.part].atomic,n=t.atomic;e==n?delete this.selectedUnits[t.part]:this.selectedUnits[t.part]=t,this.selectedUnits=JSON.parse(JSON.stringify(this.selectedUnits))}},resetUnit:function(){this.originUnits=[],this.selectedUnits={}},composeUnit:function(){if(this.rootAccount.isLoggedIn)if(this.checkAllowance())if(Object.keys(this.selectedUnits).length<5)this.$message.showMessage("请选择组件");else if(this.checkBalance()){var t=Object.values(this.selectedUnits).map((function(t){return t.token}),[]);this.merge(t)}else this.$message.showMessage("余额不足，请充值");else this.approve();else this.$EventBus.$emit("showConnect")},approve:function(){var t=this;if(!this.loading){this.loading=!0;var e=this.convertToWei(m["a"]);this.goldCTR.methods.approve(y,e).send({from:this.currentAccount}).on("transactionHash",(function(t){console.log("approve","正在执行智能合约",t)})).then((function(){t.loading=!1,t.GTAllowance=e,t.$message.showMessage("授权成功"),console.log("approve","合约执行成功")})).catch((function(e){t.loading=!1,t.$message.showMessage("授权失败，请重试"),console.log("approve",e)}))}},merge:function(t){var e=this;this.loading||(console.warn("merge unit ids",t),this.loading=!0,this.mergeCTR.methods.merge(t).send({from:this.currentAccount}).on("transactionHash",(function(t){console.log("merge","正在执行智能合约",t)})).then((function(t){console.log("merge",t),e.mint(t.transactionHash)})).catch((function(t){e.loading=!1,e.$message.showMessage("合成失败，请重试"),console.log("merge",t)})))},mint:function(t){var e=this;Object(f["d"])(t).then((function(t){e.loading=!1,e.hero=t.hero,e.pConfirm.showDialog({type:"success",title:"组合成功!",confirmText:"确定"}),e.resetUnit(),e.getUnit()})).catch((function(n){console.log("mint",n),e.retry>=e.maxRetry?(e.loading=!1,e.pConfirm.showDialog({type:"error",title:"组合失败!",confirmText:"确定"})):(e.mint(t),e.retry++)}))},getMergeAmount:function(){var t=this;this.mergeCTR.methods.mergeAmount().call().then((function(e){t.mergeAmount=+t.convertToEther(e,0),console.log("[wallet] merge amount: ",t.mergeAmount)})).catch((function(t){console.warn("[wallet] merge amount: ",t)}))},getGTAllowance:function(){var t=this;console.warn("getGTAllowance",this.currentAccount,y),this.goldCTR.methods.allowance(this.currentAccount,y).call().then((function(e){console.log("[wallet] my GT allowance for merge: ",e),t.GTAllowance=e})).catch((function(t){console.error("[wallet] my GT allowance for merge: ",t)}))},getGTBalance:function(){var t=this;this.goldCTR.methods.balanceOf(this.currentAccount).call().then((function(e){console.log("[wallet] my GT: ",e),t.setGT(e)}))},checkAllowance:function(){var t=this.convertToEther(this.GTAllowance);return!(t<=0||t<this.mergeAmount)},checkBalance:function(){return!(this.mergeAmount>this.convertToEther(this.GT))},convertToEther:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,n=new RegExp("^(.*\\..{"+e+"}).*$","g");return this.web3.utils.fromWei(t+"","ether").replace(n,"$1")},convertToWei:function(t){return this.web3.utils.toWei(t+"","ether")}})},O=x,k=(n("8e57"),n("2877")),j=Object(k["a"])(O,i,s,!1,null,"bbcfc8e4",null);e["default"]=j.exports},2975:function(t,e,n){},"2a1c":function(t,e,n){t.exports=n.p+"img/icon_success.1a72039d.png"},"2b18":function(t,e,n){t.exports=n.p+"img/img_hand.cd9acc1c.png"},"2e4a":function(t,e,n){"use strict";var i=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("v-dialog",{staticClass:"common-dialog",attrs:{width:t.width},model:{value:t.isShow,callback:function(e){t.isShow=e},expression:"isShow"}},[i("div",{staticClass:"dialog-body d-flex flex-column justify-start align-center"},[i("div",{staticClass:"dialog-close",on:{click:t.hideDialog}}),i("div",{staticClass:"dialog-content"},[t.showIcon?i("div",{staticClass:"dialog-icon"},["success"==t.type?i("img",{attrs:{src:n("2a1c"),alt:""}}):t._e(),"error"==t.type?i("img",{attrs:{src:n("a4fd"),alt:""}}):t._e(),"other"==t.type?i("img",{attrs:{src:t.dialogIcon,alt:""}}):t._e()]):t._e(),t._t("content",(function(){return[i("div",{staticClass:"dialog-title"},[t._v(t._s(t.title))])]}))],2),i("div",{staticClass:"dialog-btns d-flex"},[i("p-button",{attrs:{from:"dialog",text:t.confirmText},on:{confirm:t.confirm}})],1)])])},s=[],a=(n("a9e3"),n("82c1")),r={name:"PConfirm",components:{PButton:a["a"]},props:{width:{type:Number,default:612}},data:function(){return{isShow:!1,title:"",confirmText:"",type:"",dialogIcon:null,showIcon:!0}},methods:{showDialog:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.isShow=!0,this.title=t.title,this.type=t.type||"success",this.confirmText=t.confirmText||this.$vuetify.lang.t("$vuetify.login.confirm"),this.showIcon=void 0==t.showIcon||t.showIcon,this.dialogIcon=t.dialogIcon},hideDialog:function(){this.isShow=!1},confirm:function(){this.$emit("confirm"),this.hideDialog()}}},c=r,o=(n("7c14"),n("2877")),l=n("6544"),u=n.n(l),f=n("169a"),h=Object(o["a"])(c,i,s,!1,null,"fc18e4fe",null);e["a"]=h.exports;u()(h,{VDialog:f["a"]})},"3ab5":function(t,e,n){t.exports=n.p+"img/hero_base.6001abf9.png"},"3da1":function(t,e,n){"use strict";var i,s,a=n("5530"),r=(n("d3b7"),n("25f0"),n("fb6a"),n("4e827"),n("07ac"),n("4d90"),n("159b"),n("dd70")),c=n("2f62"),o=n("89cb"),l={data:function(){return{partOptions:r["b"],professionOptions:r["c"],originUnits:[],units:[],currentUnits:[],currentProfession:0,currentPart:0,limit:500,total:0,rules:null}},computed:Object(a["a"])({},Object(c["c"])(["web3","currentAccount","rootAccount","GT"])),created:function(){this.init()},methods:{getUnit:function(){this.getUnitCount()},getUnitCount:function(){var t=this;this.unitCTR.methods.balanceOf(this.currentAccount).call().then((function(e){if(console.log("[unit] my unit count: ",e),t.total=e,0==t.total)return t.units=[],void(t.currentUnits=[]);for(var n=Math.ceil(t.total/t.limit),i=0;i<n;i++){var s=i*t.limit,a=(i+1)*t.limit>t.total?t.total:(i+1)*t.limit;t.getUnitTokens(s,a)}})).catch((function(t){console.log(t)}))},getUnitTokens:function(t,e){var n=this;this.unitCTR.methods.tokensOf(this.currentAccount,t,e).call().then((function(i){for(var s=0;s<i.length;s++)n.originUnits[t+s]=n.formatToken(i[s]);console.log("[unit] my unit token: ",t,"-",e,i),n.getMechaUnits(i,t,e)}))},getMechaUnits:function(t,e,n){var i=this;this.unitCTR.methods.getMechaUnits(t).call().then((function(t){console.log("[unit] my unit mecha: ",e,"-",n,t);for(var s=0;s<t.length;s++)i.originUnits[e+s]=Object(a["a"])(Object(a["a"])({},i.originUnits[e+s]),i.formatAttr(t[s],e+s));n>=i.total&&(console.warn("origin uints",i.originUnits),i.initUnit())}))},formatToken:function(t){var e=this.web3.utils.toBN(t),n=e.toString(2),i=parseInt(n.slice(-8),2),s=parseInt(n.slice(-11,-8),2),a=parseInt(n.slice(-14,-11),2),r=parseInt(n.slice(-18,-14),2),c=parseInt(n.slice(0,-18),2);return{token:t,atomic:i,quality:s,part:a,profession:r,timestamp:c}},formatAttr:function(t,e){var n=this.web3.utils.toBN(t),i=n.toString(2),s=this.originUnits[e],r=this.rules[s.part],c={},o=Object.values(r).sort((function(t,e){return t.sort-e.sort})),l=o.reduce((function(t,e){return t+e.bit_num}),0);return i.length<l&&(i=i.padStart(l,"0")),o.forEach((function(t){c[t.attr_key]=parseInt(i.slice(t.start,t.end),2)||0})),Object(a["a"])({attr:t},c)},getRules:function(){return new Promise((function(t){Object(o["b"])().then((function(e){var n={};e.rule.forEach((function(t){var e=t.part,i=t.attrs,s={},a=0;i.sort((function(t,e){return t.sort-e.sort})).forEach((function(t){t.start=a,t.end=a+t.bit_num,s[t.attr_key]=t,a=t.end})),n[e]=s})),t(n)}))}))}}},u=l,f=n("2877"),h=Object(f["a"])(u,i,s,!1,null,null,null);e["a"]=h.exports},"576b":function(t,e,n){},"5a88":function(t,e,n){t.exports=n.p+"img/img_body.b2c84633.png"},6062:function(t,e,n){"use strict";var i=n("6d61"),s=n("6566");i("Set",(function(t){return function(){return t(this,arguments.length?arguments[0]:void 0)}}),s)},"7c14":function(t,e,n){"use strict";n("cf1a")},8336:function(t,e,n){t.exports=n.p+"img/img_head.c947a839.png"},"8e57":function(t,e,n){"use strict";n("2975")},"9cfc":function(t,e,n){t.exports=n.p+"img/hero_light.5cc152f4.png"},a4fd:function(t,e,n){t.exports=n.p+"img/icon_error.fe77c5ae.png"},afed:function(t,e,n){"use strict";n("576b")},cf1a:function(t,e,n){},d230:function(t,e,n){"use strict";var i=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"part-item",class:"quality"+t.item.quality+" "+t.type},[i("div",{staticClass:"part-detail",class:t.selectedUnits&&t.selectedUnits[t.item.part]&&t.selectedUnits[t.item.part].atomic==t.item.atomic?"active":""},[i("div",{staticClass:"part-profession"},[i("img",{attrs:{src:t.partImgs["profession"+t.item.profession],alt:""}})]),i("div",{staticClass:"part-pos"},[i("img",{attrs:{src:t.partImgs["part"+t.item.part],alt:""}})]),i("div",{staticClass:"part-img d-flex flex-column align-center justify-center"},[1==t.item.part?i("img",{attrs:{src:n("8336"),alt:""}}):t._e(),2==t.item.part?i("img",{attrs:{src:n("5a88"),alt:""}}):t._e(),3==t.item.part?i("img",{attrs:{src:n("2b18"),alt:""}}):t._e(),4==t.item.part?i("img",{attrs:{src:n("ea65"),alt:""}}):t._e(),5==t.item.part?i("img",{attrs:{src:n("0ba4"),alt:""}}):t._e()]),i("div",{staticClass:"part-attrs d-flex flex-column justify-center align-center",class:"quality"+t.item.quality},[t._l(t.attrs,(function(e,n){return[t.item[e]?i("div",{key:n,staticClass:"part-attr d-flex"},[i("img",{staticClass:"attr-icon",attrs:{src:t.partImgs[e],alt:""}}),i("div",{staticClass:"attr-name"},[t._v(t._s(t.attrMap[e]))]),i("div",{staticClass:"attr-value"},[t._v(t._s(t.item[e]))])]):t._e()]}))],2)])])},s=[],a=n("2909"),r=n("1da1"),c=(n("96cf"),n("e9c4"),n("d3b7"),n("159b"),n("4e827"),n("b64b"),n("6062"),n("3ca3"),n("ddb0"),n("ac1f"),n("5319"),n("89cb")),o=n("ed08"),l={name:"PCard",props:{item:{type:Object,default:null},selectedUnits:{type:Object,default:null},type:{type:String,default:"small"}},data:function(){return{partImgs:{},rules:null,attrs:[],attrMap:{blood:"生命力",attack_value:"攻击力",dodge:"闪避",hit:"命中",physical_defends:"装甲防御",magic_defends:"能量防御",reduce_harm_percent:"反伤(%)",reverse_harm_percent:"减伤(%)",attack_speed:"攻击速度",suck_blood:"吸血",critical_hit_rate:"暴击率(%)",critical_hit_effect:"暴击效果"}}},created:function(){var t=this;return Object(r["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.loadImgs(),!Object(o["d"])("UNIT_CODE_RULE")){e.next=5;break}t.rules=Object(o["d"])("UNIT_CODE_RULE"),e.next=9;break;case 5:return e.next=7,t.getRules();case 7:t.rules=e.sent,Object(o["g"])("UNIT_CODE_RULE",JSON.stringify(t.rules));case 9:t.attrs=t.getAttrs();case 10:case"end":return e.stop()}}),e)})))()},methods:{getRules:function(){return new Promise((function(t){Object(c["b"])().then((function(e){var n={};e.rule.forEach((function(t){var e=t.part,i=t.attrs,s={},a=0;i.sort((function(t,e){return t.sort-e.sort})).forEach((function(t){t.start=a,t.end=a+t.bit_num,s[t.attr_key]=t,a=t.end})),n[e]=s})),t(n)}))}))},getAttrs:function(){var t=[];for(var e in this.rules)t.push.apply(t,Object(a["a"])(Object.keys(this.rules[e])));return Object(a["a"])(new Set(t))},loadImgs:function(){var t=this,e=n("c84d");e.keys().forEach((function(e){n("b4c4")("./part"+e.replace(".","")).then((function(n){var i=/\.\/(.+)\.png/,s=i.exec(e)[1];t.$set(t.partImgs,s,n.default)}))}))}}},u=l,f=(n("afed"),n("2877")),h=Object(f["a"])(u,i,s,!1,null,"7b61c524",null);e["a"]=h.exports},ea65:function(t,e,n){t.exports=n.p+"img/img_leg.7613f29b.png"}}]);